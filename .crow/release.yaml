clone:
  git:
    image: docker.io/thegeeklab/wp-git-clone:1.0.14
    settings:
      tags: true

when:
  - event: [pull_request, tag, deployment]
  - event: push
    branch:
      - ${CI_REPO_DEFAULT_BRANCH}

variables:
  - &buildx_plugin 'docker.io/woodpeckerci/plugin-docker-buildx:5.1.0'
  - &repo 'ghcr.io/crowci/crow-autoscaler'
  - &platforms 'linux/arm/v7,linux/arm64/v8,linux/amd64,linux/ppc64le'
  - &golang_image 'docker.io/golang:1.23-alpine3.21'
  - publish_logins: &publish_logins
      - registry: https://ghcr.io/v2/
        username: crowci-bot
        password:
          from_secret: GITHUB_PKGS_TOKEN
      - registry: https://index.docker.io/v1/
        username: devxygmbh
        password:
          from_secret: docker_password

steps:
  vendor:
    image: *golang_image
    commands:
      - go mod vendor

  build-image-dryrun:
    image: *buildx_plugin
    settings:
      dockerfile: Dockerfile
      dry_run: true
      repo: *repo
      platforms: *platforms
      tag: test
      username: crowci-bot
      logins: *publish_logins
    when:
      - event: pull_request
      - event: push
        branch:
          - ${CI_REPO_DEFAULT_BRANCH}

  publish-dev:
    image: *buildx_plugin
    settings:
      dockerfile: Dockerfile
      repo: *repo
      platforms: *platforms
      tag: dev
      logins: *publish_logins
    when:
      event: deployment

  publish-tag:
    image: *buildx_plugin
    settings:
      dockerfile: Dockerfile
      repo: *repo
      platforms: *platforms
      tag: ['${CI_COMMIT_TAG%%.*}', '${CI_COMMIT_TAG%.*}', '${CI_COMMIT_TAG}']
      logins: *publish_logins
    when:
      event: tag

  changelog:
    image: docker.io/thegeeklab/git-sv:1.0.10
    commands:
      - git sv current-version
      - git sv release-notes -t ${CI_COMMIT_TAG:-dev} -o CHANGELOG.md
      - cat CHANGELOG.md
    when:
      event: tag

  'Create release':
  image: docker.io/woodpeckerci/plugin-release:0.2.3
  settings:
    files:
      - CHANGELOG.md
    api_key:
      from_secret: codeberg_bot_token
